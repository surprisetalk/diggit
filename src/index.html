<!doctype html>
<html lang="en">
  <head>
    <title>scrapsheets</title>
    <meta charset="UTF-8" />
    <meta name="author" content="Taylor Troesh" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light" />
    <link href="/style.css" rel="stylesheet" />
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>
    <script src="/index.js"></script>
  </head>
  <body>
    <div id="elm"></div>
    <script type="module">
      import http from "https://unpkg.com/isomorphic-git/http/web/index.js";
      window.fs = new LightningFS("fs");
      window.pfs = window.fs.promises;
      try {
        const app = Elm.Main.init({
          node: document.getElementById("elm"),
          flags: {
            claudeAuth: localStorage.getItem("claudeAuth"),
            claudeModel: localStorage.getItem("claudeModel") || "sonnet41",
          },
        });

        app.ports.requestRepo.subscribe(async (repoUrl) => {
          try {
            console.log(`Cloning repository: ${repoUrl}`);

            const dir = `/repos/${repoUrl}`;
            const url = `https://github.com/${repoUrl}`;

            let cache = {};

            // Report initial progress
            if (app.ports.progressReported) {
              app.ports.progressReported.send({
                message: `Cloning ${repoUrl}...`,
                progress: 0.0,
              });
            }

            await git.clone({
              cache,
              fs: window.fs,
              http,
              dir,
              corsProxy: "https://cors.isomorphic-git.org",
              url,
              depth: 1000,
              batchSize: 100,
              singleBranch: true,
              noCheckout: true,
              onProgress: (event) => {
                console.log(event);
                if (
                  app.ports.progressReported &&
                  event.phase &&
                  event.loaded &&
                  event.total
                ) {
                  const progress = event.loaded / event.total;
                  app.ports.progressReported.send({
                    message: `${event.phase}: ${repoUrl}`,
                    progress: Math.min(progress, 0.99), // Keep under 1.0 until fully complete
                  });
                }
              },
              onMessage: (message) => {
                console.log(message);
                if (app.ports.progressReported) {
                  app.ports.progressReported.send({
                    message: `${repoUrl}: ${message}`,
                    progress: 0.5,
                  });
                }
              },
            });

            // Report fetching commits
            if (app.ports.progressReported) {
              app.ports.progressReported.send({
                message: `Fetching commits for ${repoUrl}...`,
                progress: 0.7,
              });
            }

            const commits = await git.log({
              fs: window.fs,
              dir,
              depth: 1000,
            });

            const authors = {};
            const commitData = {};

            for (const commit of commits) {
              const authorId = commit.commit.author.email;

              if (!authors[authorId]) {
                authors[authorId] = {
                  id: authorId,
                  name: commit.commit.author.name,
                  email: commit.commit.author.email,
                  avatarUrl: null,
                };
              }

              commitData[commit.oid] = {
                id: commit.oid,
                url: `${url}/commit/${commit.oid}`,
                start: commit.commit.author.timestamp * 1000,
                end: null,
                insertions: 0,
                deletions: 0,
                tags: ["commit", `@${commit.commit.author.name}`],
                summary: commit.commit.message,
              };
            }

            const branches = await git.listBranches({
              fs: window.fs,
              dir,
            });

            const branchData = {};
            for (const branch of branches) {
              const branchCommit = await git.resolveRef({
                fs: window.fs,
                dir,
                ref: branch,
              });

              branchData[branch] = {
                id: branchCommit,
                url: `${url}/tree/${branch}`,
                start: Date.now(),
                end: null,
                insertions: 0,
                deletions: 0,
                tags: ["branch", `>${branch}`],
                summary: `Branch: ${branch}`,
              };
            }

            const files = await getFileList(dir);

            const repoData = {
              url: url,
              commits: commitData,
              authors: authors,
              tags: {},
              branches: branchData,
              files: files,
              github: {
                issues: {},
                events: {},
                users: {},
              },
              report: null,
            };

            // Report completion
            if (app.ports.progressReported) {
              app.ports.progressReported.send({
                message: `Completed loading ${repoUrl}`,
                progress: 1.0,
              });
            }

            app.ports.repoLoaded.send(repoData);
          } catch (error) {
            console.error("Failed to clone repository:", error);

            // Send error through pageErrored port
            if (app.ports.pageErrored) {
              app.ports.pageErrored.send(
                error.message || "Failed to clone repository",
              );
            }

            // Clear any progress
            if (app.ports.progressReported) {
              app.ports.progressReported.send({
                message: `Cloning ${repoUrl}...`,
                progress: 1.0, // This will remove the progress bar
              });
            }
          }
        });

        async function getFileList(dir, path = "") {
          const files = [];
          try {
            const entries = await window.pfs.readdir(dir + path);
            for (const entry of entries) {
              const fullPath = path + "/" + entry;
              const stat = await window.pfs.stat(dir + fullPath);
              if (stat.isDirectory()) {
                const subFiles = await getFileList(dir, fullPath);
                files.push(...subFiles);
              } else {
                files.push(fullPath.substring(1));
              }
            }
          } catch (error) {
            console.warn(`Could not read directory ${dir + path}:`, error);
          }
          return files;
        }
      } catch (error) {
        console.error(error);
        if (app && app.ports && app.ports.pageErrored) {
          app.ports.pageErrored.send(error?.message ?? "Something went wrong.");
        } else {
          document.body.innerHTML = `<div style="padding: 20px; color: red;">Error: ${error?.message ?? "Something went wrong."}</div>`;
        }
      }
    </script>
  </body>
</html>
