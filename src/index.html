<!doctype html>
<html lang="en">
  <head>
    <title>scrapsheets</title>
    <meta charset="UTF-8" />
    <meta name="author" content="Taylor Troesh" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light" />
    <link href="/style.css" rel="stylesheet" />
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>
    <script src="/index.js"></script>
  </head>
  <body>
    <div id="elm"></div>
    <script type="module">
      import http from "https://unpkg.com/isomorphic-git/http/web/index.js";
      window.fs = new LightningFS("fs");
      window.pfs = window.fs.promises;
      try {
        const app = Elm.Main.init({
          node: document.getElementById("elm"),
          flags: {
            claudeAuth: localStorage.getItem("claudeAuth"),
            claudeModel: localStorage.getItem("claudeModel") || "sonnet41",
          },
        });

        let cache = {};
        let loadInterval;

        app.ports.requestRepo.subscribe(async (repoUrl) => {
          if (!repoUrl) return;
          const loading = (progress) =>
            // TODO: Is this working?
            app.ports.progressReported.send({
              message: `Cloning ${repoUrl}...`,
              progress,
            });

          try {
            const dir = `/repos/${repoUrl}`;
            const url = `https://github.com/${repoUrl}`;

            loading(0.1);

            let n = 0;
            loadInterval = setInterval(
              () => loading(Math.min(0.7, (0.1 + ++n * 0.0005) / 0.7)),
              100,
            );

            await git.clone({
              cache,
              fs: window.fs,
              http, // TODO: Track progress?
              dir,
              corsProxy: "https://cors.isomorphic-git.org",
              url,
              since: new Date(0),
              singleBranch: false,
              noCheckout: false,
              onMessage: console.log,
              onProgress: (event) =>
                event.phase &&
                event.loaded &&
                event.total &&
                app.ports.progressReported.send({
                  message: `${repoUrl}: ${event.phase}`,
                  progress: event.loaded / event.total,
                }),
            });

            clearInterval(loadInterval);

            loading(0.7);

            const commits = await git.log({
              cache,
              fs: window.fs,
              dir,
            });

            const authors = {};
            const commitData = {};

            for (const commit of commits) {
              const authorId = commit.commit.author.email;

              if (!authors[authorId])
                authors[authorId] = {
                  id: authorId,
                  name: commit.commit.author.name,
                  email: commit.commit.author.email,
                  avatarUrl: null,
                };

              commitData[commit.oid] = {
                id: commit.oid,
                url: `${url}/commit/${commit.oid}`,
                start: commit.commit.author.timestamp * 1000,
                end: null,
                insertions: 0,
                deletions: 0,
                tags: ["commit", `@${commit.commit.author.name}`], // TODO: Add other tags, e.g. >branch, .ext, /dir, #tag, @author
                summary: commit.commit.message,
              };
            }

            loading(0.8);

            const branches = await git.listBranches({
              cache,
              fs: window.fs,
              dir,
            });

            const branchData = {};
            for (const branch of branches) {
              const branchCommit = await git.resolveRef({
                cache,
                fs: window.fs,
                dir,
                ref: branch,
              });
              branchData[branch] = {
                id: branchCommit,
                url: `${url}/tree/${branch}`,
                start: Date.now(), // TODO:
                end: null,
                insertions: 0,
                deletions: 0,
                tags: ["branch", `>${branch}`], // TODO: Add other tags, e.g. >branch, .ext, /dir, #tag, @author
                summary: `Branch: ${branch}`,
              };
            }

            loading(0.9);

            // TODO: Inline this.
            async function getFileList(dir, path = "") {
              const files = [];
              try {
                const entries = await window.pfs.readdir(dir + path);
                for (const entry of entries) {
                  const fullPath = path + "/" + entry;
                  const stat = await window.pfs.stat(dir + fullPath);
                  if (stat.isDirectory()) {
                    const subFiles = await getFileList(dir, fullPath);
                    files.push(...subFiles);
                  } else {
                    files.push(fullPath.substring(1));
                  }
                }
              } catch (error) {
                console.warn(`Could not read directory ${dir + path}:`, error);
              }
              return files;
            }
            const files = await getFileList(dir);

            app.ports.repoLoaded.send({
              url: url,
              commits: commitData,
              authors: authors,
              tags: {},
              branches: branchData,
              files: files,
              github: {
                issues: {},
                events: {},
                users: {},
              },
              report: null,
            });
          } catch (error) {
            console.error("Failed to clone repository:", error);
            app.ports.pageErrored.send(
              error?.message ?? "Failed to clone repository",
            );
          } finally {
            clearInterval(loadInterval);
            loading(1.0);
          }
        });
      } catch (error) {
        console.error(error);
        app.ports.pageErrored.send(error?.message ?? "Something went wrong.");
      }
    </script>
  </body>
</html>
